{{#> layout }}

<script src="/ui/asciidoctor/asciidoctor.js"></script>
<script src="/ui/monaco/min/vs/loader.js"></script>

<style>
  #rationale {
    font-size: 80%;
  }

  #rationale code {
    font-weight: 900;
    padding: 0;
  }

  #rationale_body div.entry {
    padding: 1ex;
    border-left: 1px solid #333;
    margin-bottom: 1ex;
  }

  #rationale_body div.field {
    border-bottom: 1px dotted #ccc;
    padding-bottom: 1ex;
    background-color: inherit;
  }

  #rationale_body div.field-name {
    background-color: inherit;
  }

  #rationale_body div.satisfied {
    background-color: #cfc;
  }

  #rationale_body div.unsatisfied {
    background-color: #fcc;
  }

  #rationale_body div.satisfied:hover {
    background-color: #9f9;
  }

  #rationale_body div.unsatisfied:hover {
    background-color: #f99;
  }

  #rationale_body code {
    background-color: inherit;
  }

  #rationale_body .input {
    background-color: #eee;
    border: 1px solid #ccc;
    padding: 1ex;
    margin-bottom: 1em;
  }

</style>

<h1 class="pf-c-title pf-m-4xl">
  <span><a href="/playground/">Playground</a> | </span>
</h1>

<div class="pf-m-gutter pf-l-grid pf-m-all-12-col-on-sm pf-m-all-6-col-on-md">
  <div class="pf-l-grid__item">
    <div class="pf-c-toolbar">
      <div class="pf-c-toolbar__content">
        <div class="pf-c-toolbar__item">Policy</div>
        <div class="pf-c-toolbar__item pf-m-align-right">
          <button id="policy_post" class="pf-c-button pf-m-progress pf-m-secondary">
                <span class="pf-c-button__progress">
                  <span class="pf-c-spinner pf-m-md" role="progressbar" aria-label="Loading...">
                    <span class="pf-c-spinner__clipper"></span>
                    <span class="pf-c-spinner__lead-ball"></span>
                    <span class="pf-c-spinner__tail-ball"></span>
                  </span>
                </span>
            Compile
          </button>
        </div>
      </div>
    </div>
    <div class="pf-c-panel">
      <div class="pf-c-banner" id="policy_status">
        POST {{compile_path}}
      </div>
      <div class="pf-c-panel__main">
        <div class="pf-c-panel__main-body">
          <form id="policy_form" class="pf-c-form">
            <div id="policy_editor" style="resize: vertical; width: 100%; height: 23em;"></div>
            <script>
              require.config({ paths: { vs: '/ui/monaco/min/vs' } });

              require(['vs/editor/editor.main'], function () {
                  var editor = monaco.editor.create(document.getElementById('policy_editor'), {
                      value: "pattern dog = {\n" +
                              "    name: string,\n" +
                              "    trained: boolean\n" +
                              "}"
                  });

                  const form = document.getElementById("policy_form");
                  form.addEventListener("formdata", e =>
                  {
                      e.formData.append('policy_body', editor.getModel().getValue());
                  });
              });
            </script>
          </form>
        </div>
      </div>
    </div>
    <div class="pf-c-panel" id="compilation">
      <div class="pf-c-panel__main">
        <div class="pf-c-panel__main-body" id="compile_body">
        </div>
      </div>
    </div>
  </div>


  <div class="pf-l-grid__item">
    <div class="pf-c-toolbar">
      <div class="pf-c-toolbar__content">
        <div class="pf-c-toolbar__item">Value</div>
        <div class="pf-c-toolbar__item pf-m-align-right">
          <button id="value_post" class="pf-c-button pf-m-progress pf-m-secondary">
                <span class="pf-c-button__progress">
                  <span class="pf-c-spinner pf-m-md" role="progressbar" aria-label="Loading...">
                    <span class="pf-c-spinner__clipper"></span>
                    <span class="pf-c-spinner__lead-ball"></span>
                    <span class="pf-c-spinner__tail-ball"></span>
                  </span>
                </span>
            Evaluate
          </button>
        </div>
      </div>
    </div>
    <div class="pf-c-panel">
      <div class="pf-c-banner" id="evaluate_status">
        POST {{eval_path}}
      </div>
      <div class="pf-c-panel__main">
        <div class="pf-c-panel__main-body">
          <form id="value_form" class="pf-c-form">
            <div id="value_editor" style="resize: vertical; width: 100%; height: 20em;"></div>
            <script>
              require.config({ paths: { vs: '/ui/monaco/min/vs' } });

              require(['vs/editor/editor.main'], function () {
                  var editor = monaco.editor.create(document.getElementById('value_editor'), {
                      value: "{ \n" +
                              "   \"name\":\"goodboy\", \n" +
                              "   \"trained\": true\n" +
                              "}",
                      language: "json"
                  });

                  const form = document.getElementById("value_form");
                  form.addEventListener("formdata", e =>
                  {
                      e.formData.append('value_body', editor.getModel().getValue());
                  });
              });
            </script>
            <input id="value_path" class="pf-c-form-control"
                   style="padding: 1ex; width: 100%; font-family: monospace;"
                   placeholder="enter pattern name"/>
          </form>
        </div>
      </div>
      <div class="pf-c-panel" id="rationale">
        <div class="pf-c-panel__header">Rationale</div>
        <div class="pf-c-panel__main">
          <div class="pf-c-panel__main-body" id="rationale_body">
            Rationale goes here.
          </div>
        </div>
      </div>
    </div>
  </div>

</div>


<script defer>

  //var adoc = Asciidoctor();
  //var documentation = $("#documentation").text();
  //var converted = adoc.convert( documentation, { "safe": "safe" }  );
  //$("#documentation").html(converted);

  //$("#documentation ul").addClass("pf-c-list");

  $("#rationale").hide();
  $("#compilation").hide();

  $("#policy_post").on("click", event => {
    $("#policy_post")
        .prop("disabled", true)
        .addClass("pf-m-in-progress");
    $('#policy_status').removeClass("pf-m-gold");
    $('#policy_status').removeClass("pf-m-green");
    $('#policy_status').removeClass("pf-m-red");
    $('#compile_body').html("");
    event.preventDefault();
    const body = new FormData(document.getElementById('policy_form')).get("policy_body");
    $.post(
        "{{compile_path}}",
        body,
        function (result) {
          $('#compile_body').html(result);
          $("#compilation").show();
          $('#policy_status').removeClass("pf-m-gold");
          $('#policy_status').removeClass("pf-m-red");
          $('#policy_status').addClass("pf-m-green");
        },
    ).fail(function (arg) {
      if (arg.status == 406) {
        $('#compile_body').html(arg.responseText);
        $("#compilation").show();
        $('#policy_status').removeClass("pf-m-gold");
        $('#policy_status').removeClass("pf-m-green");
        $('#policy_status').addClass("pf-m-red");
      } else {
        $('#compile_body').html(arg.responseText);
        $("#compilation").show();
        $('#policy_status').removeClass("pf-m-green");
        $('#policy_status').removeClass("pf-m-red");
        $('#policy_status').addClass("pf-m-gold");
      }
    }).always(function (arg) {
      $("#policy_post")
          .prop("disabled", false)
          .removeClass("pf-m-in-progress");
    })
  });

  $("#value_post").on("click", event => {
    $("#value_post")
        .prop("disabled", true)
        .addClass("pf-m-in-progress");
    $("#rationale").hide();
    $('#evaluate_status').removeClass("pf-m-gold");
    $('#evaluate_status').removeClass("pf-m-green");
    $('#evaluate_status').removeClass("pf-m-red");
    $('#rationale_body').html("");

    event.preventDefault();
    const policy_body = new FormData(document.getElementById('policy_form')).get("policy_body");
    const value_body = new FormData(document.getElementById('value_form')).get("value_body");
    const value_path = $("#value_path").val();

    const path = "{{eval_path}}/" + $("#value_path").val();
    const body = JSON.stringify({
      policy: policy_body,
      value: value_body,
    });

    $.post(
        path,
        body,
        function (result) {
          $('#rationale_body').html(result);
          $("#rationale").show();
          $('#evaluate_status').removeClass("pf-m-gold");
          $('#evaluate_status').removeClass("pf-m-red");
          $('#evaluate_status').addClass("pf-m-green");
        },
    ).fail(arg => {
      if (arg.status == 406) {
        $('#rationale_body').html(arg.responseText);
        $("#rationale").show();
        $('#evaluate_status').removeClass("pf-m-gold");
        $('#evaluate_status').removeClass("pf-m-green");
        $('#evaluate_status').addClass("pf-m-red");
      } else {
        $('#evaluate_status').removeClass("pf-m-green");
        $('#evaluate_status').removeClass("pf-m-red");
        $('#evaluate_status').addClass("pf-m-gold");
      }
    }).always(function (arg) {
      $("#value_post")
          .prop("disabled", false)
          .removeClass("pf-m-in-progress");
    })
  })

</script>

{{/layout}}
